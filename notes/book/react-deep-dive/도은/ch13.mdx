## 13.1 애플리케이션에서 확인하기

### 13.1.1 create-react-app

```ts
// reportWebVitals.ts
import { ReportHandler } from 'web-vitals';

const reportWebVitals = (onPerfEntry?: ReportHandler) => {
  if (onPerfEntry && onPerfEnty instanceof Function) {
    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
      getCLS(onPerfEntry);
      getFID(onPerfEntry);
      getFCP(onPerfEntry);
      getLCP(onPerfEntry);
      getTTFB(onPerfEntry);
    });
  }
};
export default reportWebVitals;

// index.tsx
reportWebVitals();
```

- reportWebVitals 함수는 웹에서 성능을 측정하기 위한 함수
- `web-vitals` 라이브러리 덕분에 측정
- 라이브러리가 브라우저의 웹페이지 성능을 측정할 수 있는 이유는
  - `performanceObserver`라는 API를 사용하기 때문
  - 웹페이지에서 다양한 성능을 측정할 수 있도록 도와주는 API, 브라우저에서 성능을 측정하기 위해 사용

```ts
function sendToAnalytics(metric: ReportHandler) {
  const body = JSON.stringify(metric);
  const url = '/api/analytics'; // 지표 정보를 보낼 위치

  fetch(url, { body, method: 'POST', keepalive: true });
  /**
   * @NOTE keepalive
   * 사용자가 웹 페이지를 닫거나 이동해도 요청이 중단되지 않도록 하고 싶을 때 설정
   *  페이지가 종료되는 상황에서도 요청을 완료할 수 있도록 보장
   */
}

reportWebVitals(sendToAnalytics);

function sendToAnalytics({ id, name, value }: ReportHandler) {
  ga('send', 'event', {
    eventCategory: 'Web Vitals',
    eventAction: name,
    eventValue: Math.round(name === 'CLS' ? value * 1000 : value), // 정수로 보낸닽
    eventLabel: id,
    nonInteraction: true,
  });
}

reportWebVitals(sendToAnalytics);
```

### 13.1.2 create-next-app

```ts
import { AppProps, NextWebVitalsMetric } from 'next/app';

export function reportWebVitals(metric: NextWebVitalsMetric) {
  console.log(metric);
}

function MyApp({ Component, pageProps }: AppProps) {
    return <Component {...pageProps} />
}
```

위와 같이 **예약어로 지정된 함수**인 `reportWebVitals`를 생성하면 지표를 얻을 수 있다.

- `Next.js-hydration`: 페이지가 서버 사이드에서 렌더링되어 하이드레이션하는 데 걸린 시간
- `Next.js-route-change-to-render`: 페이지가 경로를 변경한 후 페이지를 렌더링을 시작하는 데 걸리는 시간
- `Next.js-render`: 경로 변경이 완료된 후 페이지를 렌더링하는 데 걸린 시간

## 13.2 구글 라이트하우스

### 13.2.1 구글 라이트하우스 - 탐색 모드

- 페이지에 접속했을 때부터 페이지 로딩이 완료될 때까지의 성능을 측정하는 모드
- 페이지를 처음부터 다시 불러와서 페이지 로딩이 끝날 때까지 각각의 지표를 수집
- 수집이 완료되면 리포트 확인 가능

<p align="center">
  <img src="https://lh3.googleusercontent.com/F7ikgmKQrmoyHN4Xdmf7AoXI-tLGPyhRuymX8cZp9Xu-CoSxpyAmXQgKCToiuOFQOF9omSuIzBRz0ZHX0N4XsCXf4A=s1280-w1280-h800" />
</p>

#### 성능

- 핵심 웹 지표인 최초 콘텐츠풀 페인트(FCP), 최대 콘텐츠풀 페인트(LCP), 누적 레이아웃 이동(CLS) 외에도 3가지 추가적인 지표가 있다
  - Time to Interactive
    - 페이지에서 사용자가 완저니 상호작용할 수 있을 때까지 걸리는 시간
    - 최초 콘텐츠풀 페인트로 측정되는 페이지 내 콘텐츠가 표시되는 시점
    - 보여지는 페이지 요소의 대부분의 이벤트 핸들러가 부착되는 시점
    - 페이지가 유저의 상호작용에 50ms 내로 응답하는 시점
    - 구글에선, 이 TTI 지표가 `3.8초 이내`면 좋다고 본다.
    - 최대한 빠르게 상호작용이 되도록 준비하려면
      - 메인 스레드가 하는 자바스크립트 작업을 최소화
      - 전체적인 자바스크립트 실행 속도 또한 높일 필요
  - Speed Index
    - 페이지가 로드되는 동안 콘텐츠가 얼마나 빨리 시각적으로 표시되는지를 계산
    - 라이트하우스는 브라우저에서 로드되는 페이지를 실시간으로 캡쳐하고
    - `speedline` 라이브러리를 사용해 캡처된 이미지를 분석해 계산
    - 구글에서는 이 지표가 `3.4초 이내`면 좋다고 본다.
  - Total Blocking Time
    - 메인 스레드에서 특정 시간 이상 실행되는 작업
    - 즉, 긴 작업이 수행될 때마다 메인 스레드가 차단된 것으로 간주
    - 메인 스레드가 차단됐다고 표현하는 이유는 브라우저가 이렇게 길게 실행되는 작업 때문에 무언가 다른 작업을 수행할 수 없기 때문
    - 메인 스레드에서 실행하는 작업이 `50ms 이상` 걸리면 이를 **긴 작업을 간주**
    - 이렇게 실행되는 긴 작업을 모아서 Total Blocking Time(총 차단 시간)이라고 한다
    - 모두 합해서 계산

#### 접근성

- 웹 접근성
- 접근성 점수가 낮거나 미비한 부분이 있으면 확인 가능
- 어떻게 수정해야 하는지도 알려준다.

#### 권장사항

- 보안, 표준 모드, 최신 라이브러리, 소스 맵 등 다양한 요소들이 포함
  - CSP가 XSS 공격에 효과적인지 확인
    - XSS란, Cross Site Scripting의 약자로, 스크립트를 통해 공격하는 기법
    - CSP란, Content Security Policy의 약자로, 웹 사이트에서 호출할 수 있는 컨텐츠를 제한하는 정책
  - 감지된 JS 라이브러리
    - 페이지에서 감지된 자바스크립트 라이브러리
  - HTTPS 사용
    - HTTP 대신 보안이 더 강력한 HTTPS를 사용하는지 확인
  - 페이지 로드 시 위치정보 권한 요청 방지하기
    - 사용자의 동의 없이 페이지 로드 시 사용자의 물리적 위치를 메서드를 통해 알 수 있다.
    - 물론, 이 두 함수가 호출된다고 해서 바로 위치 정보를 가져올 수 있는 것은 아니지만
    - 다짜고짜 페이지 로드 시 요청하는 것은 사용자의 특별한 액션 없이 가져오는 것이므로
    - 사용자의 액션 이후에 실행되어야 한다
  - 페이지 로드 시 알림 권한 요청 방지하기
    - 페이지 로드 시 웹 페이지 알림을 요청하는 메서드를 실행하는지 검사
    - 사용자 액션이 있을 때만 호출하는 것이 좋다
  - 알려진 보안 취약점이 있는 라이브러리를 사용하지 않음
    - 보안 취약점이 존재하는 라이브러리를 사용하는지 확인
  - 사용자가 비밀번호 입력란에 붙여넣을 수 있도록 허용
    - 일부 사용자는 비밀번호를 관리하지 않고 복붙하여 입력
    - 이는 보안 관점에서 타양한 접근 방식
    - 웹에서 막지 않도록 하자
  - 이미지를 올바른 가로세로 비율로 표시
    - 실제 크기와 표시되는 크기 사이의 비율이 일치하는지를 확인
  - 이미지가 적절한 해상도로 제공됨
    - 선명하게 보일 수 있도록 크기에 맞는 해상도의 이미지를 제공하는지 확인
  - 지원 중단된 API 사용하지 않기
    - 더 이상 지원하지 않는 API는 잠재적인 보안 취약점이 될 수 있으므로 사용하지 않는 것이 좋다
  - 콘솔에 로그된 브라우저 오류 없음
    - 콘솔에 에러가 기록되는 것은 사용자에게 영향을 미치지 않을 수 있지만
    - 분명 웹페이지에 문제가 있다는 사실
    - 따라서 기록되지 않도록 해야 한다

#### 검색 엔진 최적화

- 문서를 크롤링하기 쉽게 만들었는지 확인하는 것부터
- `robots.txt`가 유효한지
- 이미지와 링크에 설명 문자가 존재하는지
- `<meta>`나 `<title>` 등으로 페이지의 정보를 빠르게 확인할 수 있는지 등을 확인

#### 13.2.2 구글 라이트하우스 - 기간 모드
